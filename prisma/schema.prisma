generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// ==================== AUTH & USERS ====================

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  hashedPassword String
  role           UserRole @default(CREDIT_OFFICER)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  approvedLoans    Loan[]          @relation("ApprovedBy")
  reviewedAlerts   AnomalyAlert[]  @relation("ReviewedBy")
  conductedInterviews LoanInterview[] @relation("ConductedBy")

  @@map("users")
}

enum UserRole {
  ADMIN
  CREDIT_OFFICER
  MEMBER
}

// ==================== MEMBERS ====================

model Member {
  id                  String           @id @default(uuid())
  membershipNumber    String           @unique
  firstName           String
  middleName          String?
  lastName            String
  dateOfBirth         DateTime
  gender              Gender
  civilStatus         CivilStatus
  barangay            String
  city                String           @default("Cagayan de Oro")
  province            String           @default("Misamis Oriental")
  contactNumber       String
  email               String?
  employmentType      EmploymentType
  employerOrBusiness  String?
  monthlyIncome       Decimal          @db.Decimal(12, 2)
  membershipDate      DateTime
  membershipStatus    MembershipStatus @default(ACTIVE)
  pmesCompletionDate  DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  shareCapital        ShareCapital[]
  savingsAccounts     SavingsTransaction[]
  loans               Loan[]
  guarantorOf         Guarantor[]       @relation("GuarantorMember")
  activityAttendance  ActivityAttendance[]
  committeeService    CommitteeService[]
  referralsMade       MemberReferral[]  @relation("Referrer")
  referralsReceived   MemberReferral[]  @relation("ReferredMember")
  serviceUsage        CoopServiceUsage[]
  creditScores        CreditScore[]
  anomalyAlerts       AnomalyAlert[]
  loanInterviews      LoanInterview[]

  @@map("members")
}

enum Gender {
  MALE
  FEMALE
}

enum CivilStatus {
  SINGLE
  MARRIED
  WIDOWED
  SEPARATED
}

enum EmploymentType {
  EMPLOYED
  SELF_EMPLOYED
  BUSINESS_OWNER
  FARMER
  UNEMPLOYED
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

// ==================== SHARE CAPITAL ====================

model ShareCapital {
  id              String                   @id @default(uuid())
  memberId        String
  transactionDate DateTime
  transactionType ShareCapitalTransactionType
  amount          Decimal                  @db.Decimal(12, 2)
  runningBalance  Decimal                  @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime                 @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, transactionDate])
  @@map("share_capital")
}

enum ShareCapitalTransactionType {
  CONTRIBUTION
  WITHDRAWAL
  DIVIDEND_REINVESTMENT
  PATRONAGE_REINVESTMENT
}

// ==================== SAVINGS ====================

model SavingsTransaction {
  id              String                    @id @default(uuid())
  memberId        String
  accountType     SavingsAccountType
  transactionDate DateTime
  transactionType SavingsTransactionType
  amount          Decimal                   @db.Decimal(12, 2)
  runningBalance  Decimal                   @db.Decimal(12, 2)
  createdAt       DateTime                  @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, transactionDate])
  @@map("savings_transactions")
}

enum SavingsAccountType {
  REGULAR
  TIME_DEPOSIT
  SPECIAL
}

enum SavingsTransactionType {
  DEPOSIT
  WITHDRAWAL
  INTEREST_CREDIT
}

// ==================== LOANS ====================

model Loan {
  id                  String     @id @default(uuid())
  memberId            String
  loanType            LoanType
  principalAmount     Decimal    @db.Decimal(12, 2)
  interestRate        Decimal    @db.Decimal(5, 4)
  termMonths          Int
  applicationDate     DateTime
  approvalDate        DateTime?
  releaseDate         DateTime?
  maturityDate        DateTime
  status              LoanStatus @default(PENDING)
  purpose             String
  approvedById        String?
  narrativeAssessment Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  member     Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  approvedBy User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  payments   LoanPayment[]
  guarantors Guarantor[]
  interviews LoanInterview[]

  @@index([memberId, status])
  @@map("loans")
}

enum LoanType {
  MICRO
  REGULAR
  EMERGENCY
  EDUCATIONAL
  LIVELIHOOD
  HOUSING
}

enum LoanStatus {
  PENDING
  APPROVED
  RELEASED
  CURRENT
  PAID
  DELINQUENT
  DEFAULT
  RESTRUCTURED
}

// ==================== LOAN PAYMENTS ====================

model LoanPayment {
  id          String        @id @default(uuid())
  loanId      String
  dueDate     DateTime
  paymentDate DateTime?
  amountDue   Decimal       @db.Decimal(12, 2)
  amountPaid  Decimal       @db.Decimal(12, 2) @default(0)
  principal   Decimal       @db.Decimal(12, 2)
  interest    Decimal       @db.Decimal(12, 2)
  penalty     Decimal       @db.Decimal(12, 2) @default(0)
  status      PaymentStatus @default(MISSED)
  createdAt   DateTime      @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId, dueDate])
  @@map("loan_payments")
}

enum PaymentStatus {
  ON_TIME
  LATE
  MISSED
  PARTIAL
}

// ==================== GUARANTORS ====================

model Guarantor {
  id                String          @id @default(uuid())
  loanId            String
  guarantorMemberId String
  guaranteedAmount  Decimal         @db.Decimal(12, 2)
  status            GuarantorStatus @default(ACTIVE)
  createdAt         DateTime        @default(now())

  loan      Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)
  guarantor Member @relation("GuarantorMember", fields: [guarantorMemberId], references: [id])

  @@unique([loanId, guarantorMemberId])
  @@map("guarantors")
}

enum GuarantorStatus {
  ACTIVE
  CALLED
  RELEASED
}

// ==================== COOPERATIVE ACTIVITIES ====================

model CoopActivity {
  id           String           @id @default(uuid())
  activityType ActivityType
  title        String
  date         DateTime
  cetfFunded   Boolean          @default(false)
  category     ActivityCategory
  createdAt    DateTime         @default(now())

  attendance ActivityAttendance[]

  @@map("coop_activities")
}

enum ActivityType {
  GENERAL_ASSEMBLY
  TRAINING
  SEMINAR
  COMMITTEE_MEETING
  COMMUNITY_SERVICE
  VOLUNTEER
  ELECTION
}

enum ActivityCategory {
  FINANCIAL_LITERACY
  GOVERNANCE
  LIVELIHOOD
  COOPERATIVE_PRINCIPLES
  OTHER
}

// ==================== ACTIVITY ATTENDANCE ====================

model ActivityAttendance {
  id         String  @id @default(uuid())
  activityId String
  memberId   String
  attended   Boolean @default(false)

  activity CoopActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  member   Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([activityId, memberId])
  @@map("activity_attendance")
}

// ==================== COMMITTEE SERVICE ====================

model CommitteeService {
  id            String        @id @default(uuid())
  memberId      String
  committeeName String
  role          CommitteeRole
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("committee_service")
}

enum CommitteeRole {
  MEMBER
  SECRETARY
  VICE_CHAIR
  CHAIR
}

// ==================== MEMBER REFERRALS ====================

model MemberReferral {
  id               String   @id @default(uuid())
  referrerId       String
  referredMemberId String
  referralDate     DateTime
  createdAt        DateTime @default(now())

  referrer       Member @relation("Referrer", fields: [referrerId], references: [id])
  referredMember Member @relation("ReferredMember", fields: [referredMemberId], references: [id])

  @@unique([referrerId, referredMemberId])
  @@map("member_referrals")
}

// ==================== COOP SERVICE USAGE ====================

model CoopServiceUsage {
  id              String      @id @default(uuid())
  memberId        String
  serviceType     ServiceType
  transactionDate DateTime
  amount          Decimal     @db.Decimal(12, 2)
  createdAt       DateTime    @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, transactionDate])
  @@map("coop_service_usage")
}

enum ServiceType {
  STORE
  INSURANCE
  RICE_SUBSIDY
  MEDICAL
  FUNERAL
  CALAMITY
}

// ==================== CREDIT SCORES ====================

model CreditScore {
  id              String         @id @default(uuid())
  memberId        String
  scoreDate       DateTime
  totalScore      Int
  riskCategory    RiskCategory
  scoringPathway  ScoringPathway
  dimensionScores Json
  recommendations Json?
  computedBy      ComputedBy     @default(SYSTEM)
  modelVersion    String         @default("1.0")
  createdAt       DateTime       @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, scoreDate])
  @@map("credit_scores")
}

enum RiskCategory {
  EXCELLENT
  GOOD
  FAIR
  MARGINAL
  HIGH_RISK
}

enum ScoringPathway {
  STANDARD
  THIN_FILE
}

enum ComputedBy {
  SYSTEM
  MANUAL_OVERRIDE
}

// ==================== ANOMALY ALERTS ====================

model AnomalyAlert {
  id           String        @id @default(uuid())
  memberId     String
  alertType    AlertType
  severity     Severity
  description  String
  evidence     Json
  status       AlertStatus   @default(NEW)
  reviewedById String?
  reviewNotes  String?
  detectedAt   DateTime      @default(now())
  resolvedAt   DateTime?

  member     Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  reviewedBy User?  @relation("ReviewedBy", fields: [reviewedById], references: [id])

  @@index([memberId, status])
  @@map("anomaly_alerts")
}

enum AlertType {
  WITHDRAWAL_SPIKE
  ATTENDANCE_DROP
  HOUSEHOLD_CLUSTER
  GUARANTOR_CONCENTRATION
  MANUFACTURED_PATTERN
  RAPID_LOAN_CYCLING
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
}

enum AlertStatus {
  NEW
  REVIEWED
  DISMISSED
  ACTIONED
}

// ==================== LOAN INTERVIEWS ====================

model LoanInterview {
  id            String          @id @default(uuid())
  loanId        String
  memberId      String
  conductedById String
  transcript    Json
  topicsCovered String[]
  assessment    Json?
  status        InterviewStatus @default(IN_PROGRESS)
  startedAt     DateTime        @default(now())
  completedAt   DateTime?

  loan        Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)
  member      Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  conductedBy User   @relation("ConductedBy", fields: [conductedById], references: [id])

  @@index([loanId])
  @@map("loan_interviews")
}

enum InterviewStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== AI API LOG ====================

model AIApiLog {
  id              String   @id @default(uuid())
  feature         String
  promptTokens    Int
  completionTokens Int
  latencyMs       Int
  costEstimate    Decimal  @db.Decimal(8, 6)
  success         Boolean
  errorMessage    String?
  createdAt       DateTime @default(now())

  @@index([feature, createdAt])
  @@map("ai_api_logs")
}
